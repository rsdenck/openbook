name: Release OpenBook

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Go Mod Tidy & Verify
      run: |
        go mod tidy
        go mod verify

    - name: Run Tests
      run: go test -v ./...

    - name: Set Version
      id: vars
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build Binaries
      env:
        CGO_ENABLED: 0
        VERSION: ${{ steps.vars.outputs.VERSION }}
      run: |
        mkdir -p dist
        # Declare array correctly for bash
        targets=(
          "linux/amd64"
          "linux/arm64"
          "darwin/amd64"
          "darwin/arm64"
        )

        for target in "${targets[@]}"; do
          os="${target%%/*}"
          arch="${target##*/}"
          ext=""
          
          echo "Building for $os/$arch..."
          
          # Build API
          GOOS=$os GOARCH=$arch go build -ldflags "-s -w -X main.version=$VERSION" -o "dist/openbook-api-$os-$arch$ext" ./cmd/api
          
          # Build Worker
          GOOS=$os GOARCH=$arch go build -ldflags "-s -w -X main.version=$VERSION" -o "dist/openbook-worker-$os-$arch$ext" ./cmd/worker
          
          # Package
          cd dist
          # Create a temp directory for packaging
          pkg_dir="openbook_${VERSION}_${os}_${arch}"
          mkdir -p "$pkg_dir"
          
          cp "openbook-api-$os-$arch$ext" "$pkg_dir/openbook-api$ext"
          cp "openbook-worker-$os-$arch$ext" "$pkg_dir/openbook-worker$ext"
          cp ../README.md "$pkg_dir/"
          cp ../LICENSE "$pkg_dir/" || touch "$pkg_dir/LICENSE" # Fallback if no license
          cp ../install.sh "$pkg_dir/"
          
          tar -czvf "openbook_${VERSION}_${os}_${arch}.tar.gz" -C . "$pkg_dir"
          
          # Cleanup
          rm -rf "$pkg_dir" "openbook-api-$os-$arch$ext" "openbook-worker-$os-$arch$ext"
          cd ..
        done

    - name: Generate Checksums
      working-directory: dist
      run: sha256sum *.tar.gz > checksums.txt

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/*.tar.gz
          dist/checksums.txt
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
