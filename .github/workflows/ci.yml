name: Enterprise CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  validate:
    name: Validation & Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: openbook
          POSTGRES_PASSWORD: password
          POSTGRES_DB: openbook_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Dependencies
      run: go mod download

    - name: Install Migrate Tool
      run: |
        curl -L https://github.com/golang-migrate/migrate/releases/download/v4.16.2/migrate.linux-amd64.tar.gz | tar xvz
        sudo mv migrate /usr/local/bin/migrate

    - name: Run Migrations
      run: migrate -path ./migrations -database "postgres://openbook:password@localhost:5432/openbook_test?sslmode=disable" up

    - name: Static Analysis (Go Vet)
      run: go vet ./...

    - name: Run Integration Tests
      env:
        TEST_DB_DSN: "postgres://openbook:password@localhost:5432/openbook_test?sslmode=disable"
        TEST_REDIS_ADDR: "localhost:6379"
      run: go test -v ./internal/tests/...

  build:
    name: Build & Artifacts
    needs: validate
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build API
      run: go build -o bin/api ./cmd/api

    - name: Build Worker
      run: go build -o bin/worker ./cmd/worker

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: bin/

  release:
    name: Release & Tag
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'

    - name: Bump version and push tag
      uses: anothrNick/github-tag-action@1.67.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DEFAULT_BUMP: patch

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true

  deploy:
    name: Deploy to Production
    needs: release
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: binaries
        path: bin/

    - name: Deploy to Server
      env:
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
      run: |
        if [ -z "$SSH_KEY" ]; then
          echo "SSH_KEY not set, skipping deployment execution."
          exit 0
        fi
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
        
        # SCP binaries
        scp bin/api $SSH_USER@$SSH_HOST:/opt/openbook/api_new
        scp bin/worker $SSH_USER@$SSH_HOST:/opt/openbook/worker_new
        
        # Execute deploy script
        ssh $SSH_USER@$SSH_HOST 'bash -s' < ./scripts/deploy.sh
