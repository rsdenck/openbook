name: Release OpenBook

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Go Mod Tidy & Verify
      run: |
        go mod tidy
        go mod verify

    - name: Run Tests
      run: go test -v ./...

    - name: Set Version
      id: vars
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build Binaries
      env:
        CGO_ENABLED: 0
        VERSION: ${{ steps.vars.outputs.VERSION }}
      run: |
        mkdir -p dist
        targets=(
          "linux/amd64"
          "linux/arm64"
          "darwin/amd64"
          "darwin/arm64"
        )

        for target in "${targets[@]}"; do
          os="${target%%/*}"
          arch="${target##*/}"
          ext=""
          
          echo "Building for $os/$arch..."
          
          # Build API
          GOOS=$os GOARCH=$arch go build -ldflags "-s -w -X main.version=$VERSION" -o dist/openbook-api$ext ./cmd/api
          
          # Build Worker
          GOOS=$os GOARCH=$arch go build -ldflags "-s -w -X main.version=$VERSION" -o dist/openbook-worker$ext ./cmd/worker
          
          # Package
          cd dist
          tar -czvf "openbook_${VERSION}_${os}_${arch}.tar.gz" openbook-api$ext openbook-worker$ext ../README.md ../LICENSE ../install.sh
          rm openbook-api$ext openbook-worker$ext
          cd ..
        done

    - name: Generate Checksums
      working-directory: dist
      run: sha256sum *.tar.gz > checksums.txt

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.tar.gz
          dist/checksums.txt
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
